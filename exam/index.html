<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Master - Final</title>
<style>
:root{--t:0.4s;--c:cubic-bezier(0.34,1.56,0.64,1)}
body{
    background:#000;
    color:#fff;
    font-family:'Segoe UI',sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    /* SCROLL FIX: Just 2% extra height to trigger address bar hiding */
    min-height: 102vh; 
    height: auto;
    margin:0;
    overflow-y:auto; /* Allows the tiny scroll */
    padding:0;
    user-select:none;
    -webkit-tap-highlight-color:transparent;
}
.wc{width:300px;height:300px;background:linear-gradient(145deg,#1a1a1a,#0a0a0a);border-radius:25px;border:3px solid #333;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;box-shadow:0 0 20px #000c,inset 0 1px 2px #ffffff1a;transition:border-radius var(--t) ease-in-out,width .4s ease,height .4s ease;overflow:hidden}
#clk{font-size:2.8rem;font-family:'Courier New',monospace;letter-spacing:2px;color:#0f8;text-shadow:0 0 10px #00ff881a;font-weight:300;transition:transform var(--t) var(--c);z-index:2}
#dt{font-size:.9rem;opacity:.8;color:#888;font-weight:300;position:absolute;top:20%;left:50%;transform:translateX(-50%);transition:opacity .3s,transform var(--t) var(--c);letter-spacing:1px;text-transform:uppercase}
#d-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .3s}
#d-svg text{font-family:'Segoe UI',sans-serif;font-weight:300;font-size:14px;letter-spacing:2.5px;fill:#888;text-transform:uppercase}
#bat{position:absolute;font-size:.8rem;color:#0f8;opacity:.7;transition:all var(--t) var(--c);transform:translate(-50%,-50%)}
.wc:not(.cv) #bat{top:8%;left:88%}.wc.cv #bat{top:78%;left:80%}
.sd{position:absolute;width:8px;height:8px;background:#333;border-radius:50%;transition:all .2s;transform:translate(-50%,-50%);opacity:.5}
.wc:not(.cv) .sd{top:8%;left:8%}.wc.cv .sd{top:78%;left:20%}
#mi{position:absolute;font-size:.9rem;color:#666;font-weight:700;opacity:.8;transition:all var(--t) var(--c);transform:translate(-50%,-50%);white-space:nowrap}
.wc:not(.cv) #mi{top:92%;left:85%}.wc.cv #mi{top:85%;left:50%}
#ai{position:absolute;top:55%;left:50%;transform:translate(-50%,-50%) scale(.95);width:90%;text-align:center;font-size:1.3rem;line-height:1.3;opacity:0;visibility:hidden;transition:all var(--t) var(--c),font-size .2s;word-wrap:break-word;max-height:65%;overflow-y:auto;color:#fff;z-index:10;background:#050505d9;border-radius:15px;padding:10px;box-sizing:border-box;pointer-events:auto}
#ai b,#ai strong{color:#0f8;font-weight:700}#ai ul{text-align:left;padding-left:15px;margin:5px 0}#ai li{margin-bottom:4px}
#map{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;height:90%;opacity:0;visibility:hidden;transition:all var(--t) var(--c);z-index:10;border-radius:15px;overflow:hidden;cursor:pointer}
#map img{width:100%;height:100%;object-fit:cover;border-radius:15px;transition:border-radius var(--t) var(--c)}
.sl{text-align:center;font-size:.8rem;line-height:1.4;color:#ccc;display:flex;flex-direction:column}
.wc.av #clk,.wc.mv #clk{transform:translateY(-120px) scale(.5)}
.wc.av #dt,.wc.mv #dt,.wc.av #d-svg,.wc.mv #d-svg{opacity:0;transform:translateY(-120px)}
.wc.av #bat,.wc.mv #bat,.wc.av #mi,.wc.mv #mi,.wc.av .sd,.wc.mv .sd{opacity:0;transform:translate(-50%,60px)}
.wc.av #ai{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.wc.mv #map{opacity:1;visibility:visible}
.wb{position:absolute;top:5px;left:5px;right:5px;bottom:5px;border:1px solid #333;border-radius:20px;pointer-events:none;transition:border-radius var(--t) ease-in-out}
/* MENU */
#mm{position:absolute;top:0;left:0;width:100%;height:100%;background:#000000f2;z-index:20;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:opacity .2s;overflow-y:auto}
#mm.v{opacity:1;visibility:visible}
.mb{width:80%;padding:15px;margin:8px 0;background:#222;border:1px solid #444;border-radius:10px;color:#ccc;font-size:1.1rem;text-align:center;transition:background .2s}
.mb.act{border-color:#0f8;color:#0f8;background:#003311}
.mb:active{background:#444}
/* STATES */
.sd.l{background:#06f;opacity:1;box-shadow:0 0 5px #06f}
.sd.f{background:#f90;opacity:1;box-shadow:0 0 10px #f90;animation:p .5s infinite}
.sd.s{background:#0f8;opacity:1;box-shadow:0 0 15px #0f8;animation:fl .5s forwards}
@keyframes p{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes fl{0%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(2)}100%{transform:translate(-50%,-50%) scale(1)}}
.wc.cv{border-radius:50%}.wc.cv .wb{border-radius:50%}
.wc.cv #dt{opacity:0!important;visibility:hidden!important}
.wc.cv #d-svg{opacity:.8;visibility:visible}
.wc.cv.av #clk,.wc.cv.mv #clk{transform:translateY(-115px) scale(.6)}
.wc.cv #ai{width:80%;height:65%;top:52%}.wc.cv #map{width:100%;height:100%;border-radius:50%}
.wc.cv #map img{border-radius:50%}
</style>
</head>
<body>
<div class="wc" id="wc">
<div class="wb"></div><div id="clk"></div><div id="dt"></div>
<svg id="d-svg" viewBox="0 0 300 300"><defs><path id="dp" d="M 60 150 a 90 90 0 1 1 180 0" fill="none"/></defs><text><textPath xlink:href="#dp" startOffset="50%" text-anchor="middle">LOADING...</textPath></text></svg>
<div id="ai"></div>
<div id="map"><img src="https://raw.githubusercontent.com/Success009/portfolio/refs/heads/main/exam/new-political-map-of-Nepal-1024x678.jpg" alt="Map"></div>
<div id="bat">85%</div><div class="sd" id="sd"></div><div id="mi">M1</div>
<div id="mm"></div>
</div>
<script>
// KEYS
const K1 = "AIzaSyDYneePNgz2";
const K2 = "AfGih4yIM1ag1OFykbyPTHc";
const K = K1 + K2;
const HELP=`<div class="sl"><span>SUBJECT [Name]</span><span>LISTEN [Q]</span><span>DISPLAY ANSWER</span><span>DISPLAY MODELS</span></div>`;

// PRO MODELS LIST
const MDLS = [
    {n: "Gemini 2.5 Flash", id: "gemini-2.5-flash", c:"M1"},   // Default
    {n: "Gemini 2.5 Pro",   id: "gemini-2.5-pro", c:"M2"},     // Smartest
    {n: "Gemini 3 Flash",   id: "gemini-3-flash-preview", c:"M3"}, // Newest
    {n: "Gemini Flash Lite",id: "gemini-flash-lite-latest", c:"M4"} // Fastest
];
let mIdx = 0; // Default M1

let rec,hT,mic=0,fet=0,rTo,hist=[],hI=-1,abc,fs=1.3,wl,len="concise",subj="General";
let lastReq=0;

const clk=document.getElementById('clk'),dt=document.getElementById('dt'),ai=document.getElementById('ai'),map=document.getElementById('map'),wc=document.getElementById('wc'),sd=document.getElementById('sd'),dsp=document.querySelector("#d-svg textPath"),mi=document.getElementById('mi'),mm=document.getElementById('mm');

function upd(){
    const d=new Date();
    clk.textContent=d.toLocaleTimeString('en-US',{hour12:true,hour:'numeric',minute:'2-digit'}).replace(/ AM| PM/g,"");
    dt.textContent=d.toLocaleDateString('en-US',{weekday:'short', month:'short', day:'numeric'}).toUpperCase();
    if(dsp)dsp.textContent="ENGLISH EXAM";
    mi.textContent = MDLS[mIdx].c;
}

async function wlReq(){try{if('wakeLock'in navigator)wl=await navigator.wakeLock.request('screen')}catch(e){}}

function disp(t,h=1){
    wc.classList.remove('mv');
    if(h&&t){hist.unshift(t);if(hist.length>20)hist.pop();hI=0}
    ai.innerHTML=(t||"").replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<b>$1</b>').replace(/^[\*\-]\s+(.*)$/gm,'<li>$1</li>').replace(/\n/g,'<br>');
    ai.style.fontSize=fs+'rem';
    wc.classList.add('av');
    ai.scrollTop=0;
    // Auto-stop mic when answer shown
    if(mic) togMic(false);
}

function hide(){
    wc.classList.remove('av'); 
    mm.classList.remove('v');
    wc.classList.remove('mv');
    // Ensure mic is OFF
    if(mic) togMic(false);
}

function stat(s){
    sd.className='sd';
    if(s=='l')sd.classList.add('l');
    else if(s=='f')sd.classList.add('f');
    else if(s=='s')sd.classList.add('s');
}

// --- MIC LOGIC ---
function togMic(forceState){
    if(fet) return;
    const nextState = (typeof forceState !== 'undefined') ? forceState : !mic;
    
    if(mic === nextState) return;
    
    mic = nextState;
    if(mic){
        stat('l');
        initRec();
    } else {
        stat('');
        if(rec){ try{ rec.abort(); }catch(e){} }
    }
}

function initRec(){
    if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window))return;
    if(rec){ try{rec.abort();}catch(e){} }

    rec=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
    rec.continuous=true; 
    rec.interimResults=false;
    rec.lang='en-US';
    
    rec.onstart=()=>{ if(!fet && mic) stat('l'); };
    
    rec.onresult=e=>{
        if(fet || !mic) return;
        const t=e.results[e.results.length-1][0].transcript.trim();
        const lt=t.toLowerCase();
        
        if(rTo)clearTimeout(rTo);
        rTo=setTimeout(async()=>{
            if(fet || !mic) return;
            let trigger=false;

            // 1. MENU
            if(lt.includes("display model") || lt.includes("show model") || lt.includes("change model")){
                stat('s');
                rendMenu();
                mm.classList.add('v');
                togMic(false); // Stop mic while in menu
                return;
            }

            // 2. SUBJECT
            if(lt.startsWith("subject")){
                const s = t.substring(7).trim();
                if(s){
                    subj = s;
                    stat('s');
                    disp(`<div style="margin-top:20%;color:#0f8">SUBJECT SET:<br><b style="font-size:1.5rem">${subj.toUpperCase()}</b></div>`, 0);
                    setTimeout(hide, 1500);
                    return;
                }
            }

            // 3. HISTORY
            if(lt.includes("display answer") || lt.includes("show answer") || lt.includes("previous answer")){
                stat('s');
                if(hist.length>0) disp(hist[0], 0);
                else disp("No history.", 0);
                return;
            }

            // 4. SETTINGS
            if(lt.includes("very short")){stat('s'); len="max 1 sentence"; disp("Mode: Very Short",0); setTimeout(hide,1000); return;}
            if(lt.includes("short answer")){stat('s'); len="concise points"; disp("Mode: Short",0); setTimeout(hide,1000); return;}
            if(lt.includes("long answer")){stat('s'); len="detailed points"; disp("Mode: Long",0); setTimeout(hide,1000); return;}
            if(lt.includes("map") || lt.includes("display map")){stat('s'); wc.classList.remove('av');wc.classList.add('mv'); togMic(false); return;}

            // 5. QUERY
            let q='',s=0;
            if(lt.startsWith("listen") || lt.startsWith("question") || lt.startsWith("tell me") || lt.includes("what is") || lt.includes("define") || lt.includes("explain")){
                q = t; 
                trigger=true;
            }
            else if(lt.includes("google") || lt.includes("search")){
                q=t.replace(/google|search|with google/gi,'').trim(); s=1; trigger=true;
            }
            else if(lt.startsWith("spelling of")){
                const w=t.replace(/^spelling of/i,'').trim();
                if(w){
                    stat('s');
                    const sz=Math.min(3.5, 25/w.length);
                    disp(`<div style="font-size:${sz}rem;line-height:1.1;color:#0f8;text-shadow:0 0 20px #0f8;font-weight:700;margin-top:5%;word-break:break-word">${w}</div>`);
                    return;
                }
            }
            
            if(trigger && q){
                stat('s');
                await getAI(q,s);
            }
        },400);
    };

    rec.onend=()=>{
        if(mic && !fet){
            setTimeout(()=>{ if(mic) try{rec.start();}catch(e){} },200);
        } else {
            if(!fet) stat('');
        }
    };
    try{rec.start();}catch(e){}
}

async function getAI(q,s){
    if(fet || (Date.now()-lastReq<2000)) return;
    fet=1; lastReq=Date.now();
    setTimeout(()=>stat('f'),200);
    
    if(rec) try{rec.abort();}catch(e){}

    try{
        const M_ID = MDLS[mIdx].id;
        const URL = `https://generativelanguage.googleapis.com/v1beta/models/${M_ID}:generateContent?key=${K}`;
        
        const pmpt=`System: Class 10 Exam Expert (Nepal).
SUBJECT: ${subj}.
RULES:
1. Response: ENGLISH ONLY.
2. Mode: ${len}.
3. Be direct. No filler.
Q: ${q}`;
        
        abc=new AbortController();
        const res=await fetch(URL,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:pmpt}]}],tools:s?[{googleSearch:{}}]:[]}),signal:abc.signal
        });
        
        if(res.status===429) throw new Error("Limit Reached. Switch Model.");
        if(!res.ok) throw new Error("API Error");
        
        const d=await res.json();
        const ans = d.candidates?.[0]?.content?.parts?.[0]?.text.trim();
        disp(ans || "No answer.");
    }catch(e){
        disp(`Error: ${e.message}`, 0);
    }finally{
        fet=0;
        if(mic) togMic(false); 
    }
}

function rendMenu(){
    mm.innerHTML = `<div style="font-size:0.8rem;color:#888;margin-bottom:10px;text-transform:uppercase">SELECT MODEL</div>`;
    MDLS.forEach((m,i)=>{
        const b = document.createElement('div');
        b.className = `mb ${i===mIdx?'act':''}`;
        b.innerHTML = `<b>${m.c}</b> <span style="font-size:0.9em;opacity:0.8">${m.n.replace('Gemini ','')}</span>`;
        b.onclick = (e) => {
            e.stopPropagation();
            mIdx = i;
            upd();
            mm.classList.remove('v');
            stat('s');
        };
        mm.appendChild(b);
    });
}

// --- SINGLE TAP LOGIC ---
function tapH(e){
    if(e.target.closest('.mb') || e.target.closest('a')) return;
    
    // 1. Menu Open -> Close
    if(mm.classList.contains('v')){
        mm.classList.remove('v');
        return;
    }

    // 2. Answer/Map Open -> Hide (Immediate)
    if(wc.classList.contains('av') || wc.classList.contains('mv')){
        hide();
        return;
    }

    // 3. Mic ON -> Turn OFF
    if(mic){
        togMic(false);
        return;
    }

    // 4. Default -> Turn Mic ON
    togMic(true);
}

// Touchend for fast reaction
wc.addEventListener('touchend', (e)=>{
    if(e.target.closest('#ai') && wc.classList.contains('av')) return;
    tapH(e);
});
// Mouse fallback
wc.addEventListener('click', (e)=>{
    if(e.target.closest('#ai') && wc.classList.contains('av')) return;
    tapH(e);
});

wc.addEventListener('contextmenu',e=>e.preventDefault());
map.addEventListener('click',()=>wc.classList.remove('mv'));
document.addEventListener('visibilitychange',async()=>{if(wl&&document.visibilityState==='visible')await wlReq()});

upd();wlReq();setInterval(upd,1000);
console.log("Exam Master Final Ready");
</script>
</body>
</html>
