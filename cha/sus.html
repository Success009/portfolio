<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;height:100vh;overflow:hidden}

.intruder{
background:linear-gradient(135deg,#ff6b6b,#ff3737,#ee5a52);
color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;
height:100vh;padding:40px;text-align:center;position:relative;overflow:hidden
}
.intruder::before{
content:'';position:absolute;top:0;left:0;right:0;bottom:0;
background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="40" cy="60" r="0.5" fill="rgba(255,255,255,0.08)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
opacity:0.3;animation:float 20s ease-in-out infinite
}
.intruder-icon{font-size:80px;margin-bottom:30px;animation:pulse 2s ease-in-out infinite;z-index:1}
.intruder-title{font-size:32px;font-weight:800;margin-bottom:15px;text-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1}
.intruder-subtitle{font-size:18px;opacity:0.9;font-weight:300;letter-spacing:0.5px;z-index:1}

@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-20px)}}

.chat{display:flex;flex-direction:column;height:100vh;background:#fff}
.header{
background:linear-gradient(135deg,#667eea,#764ba2);
color:white;padding:20px;font-weight:600;font-size:18px;
box-shadow:0 4px 20px rgba(0,0,0,0.1);position:relative;z-index:10
}
.messages{
flex:1;overflow-y:auto;padding:15px 10px;background:linear-gradient(to bottom,#f8f9fa,#e9ecef);
scroll-behavior:smooth;transition:all 0.3s ease
}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-track{background:transparent}
.messages::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.2);border-radius:2px}

.msg{
display:flex;margin:8px 0;opacity:0;animation:msgSlideIn 0.4s ease forwards;
transform:translateY(20px)
}
.user{justify-content:flex-start}
.me{justify-content:flex-end}
.bubble{
max-width:85%;padding:12px 16px;border-radius:20px;position:relative;
word-wrap:break-word;box-shadow:0 2px 8px rgba(0,0,0,0.1);
transition:all 0.2s ease;backdrop-filter:blur(10px)
}
.bubble:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.user .bubble{
background:linear-gradient(135deg,#fff,#f8f9fa);
color:#2c3e50;border-bottom-left-radius:6px;
border:1px solid rgba(0,0,0,0.05)
}
.me .bubble{
background:linear-gradient(135deg,#007bff,#0056b3);
color:#fff;border-bottom-right-radius:6px;
box-shadow:0 3px 10px rgba(0,123,255,0.3)
}
.time{font-size:11px;opacity:0.7;margin-top:4px;font-weight:300}

.input-area{
background:linear-gradient(to right,#fff,#f8f9fa);
padding:15px;border-top:1px solid #e9ecef;display:flex;align-items:end;
box-shadow:0 -2px 10px rgba(0,0,0,0.05)
}
.input{
flex:1;border:2px solid #e9ecef;border-radius:25px;padding:12px 18px;
outline:none;resize:none;max-height:120px;font-family:inherit;
font-size:16px;transition:all 0.3s ease;background:#fff
}
.input:focus{border-color:#007bff;box-shadow:0 0 0 3px rgba(0,123,255,0.1)}
.send{
background:linear-gradient(135deg,#007bff,#0056b3);
color:#fff;border:none;border-radius:50%;width:45px;height:45px;
margin-left:10px;cursor:pointer;font-size:18px;
transition:all 0.2s ease;box-shadow:0 3px 10px rgba(0,123,255,0.3)
}
.send:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,123,255,0.4)}
.send:active{transform:translateY(0)}

@keyframes msgSlideIn{
from{opacity:0;transform:translateY(20px) scale(0.95)}
to{opacity:1;transform:translateY(0) scale(1)}
}

.typing{
display:flex;justify-content:flex-start;margin:8px 0;opacity:0.6
}
.typing .bubble{
background:#e9ecef;color:#6c757d;padding:8px 16px;
animation:typingPulse 1.5s ease-in-out infinite
}
@keyframes typingPulse{0%,100%{opacity:0.6}50%{opacity:1}}

@media(max-width:480px){
.header{padding:15px}
.messages{padding:10px 8px}
.bubble{max-width:90%;padding:10px 14px}
.input-area{padding:12px}
.intruder-title{font-size:28px}
.intruder-subtitle{font-size:16px}
}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
const cfg={
apiKey:"AIzaSyA6sANvYoAkXHYG8MjbZl6Pyq23CNdBuzA",
authDomain:"community-canvas-255fa.firebaseapp.com",
databaseURL:"https://community-canvas-255fa-default-rtdb.firebaseio.com",
projectId:"community-canvas-255fa",
storageBucket:"community-canvas-255fa.appStorage.com",
messagingSenderId:"729445267995",
appId:"1:729445267995:web:05da6756d66c58b9ccd6be",
measurementId:"G-FW93CB5QL7"
};
firebase.initializeApp(cfg);
const db=firebase.database();
const app=document.getElementById('app');
let verified=false,msgs=[],msgContainer;

function block(){
app.innerHTML=`<div class="intruder">
<div class="intruder-subtitle">Just joking</div>
<div class="intruder-icon">ðŸ–•</div>
<div class="intruder-title">Don't fucking interfere</div>
</div>`;
}

async function ensureStructure(){
try{
const chatRef=db.ref('chatting');
const snapshot=await chatRef.once('value');
if(!snapshot.exists()){
await chatRef.set({
Token:"device_bnnkklkcm34_1756732674868",
messages:{Bhrikuti:{},success:{}}
});
}
const tokenSnapshot=await chatRef.child('Token').once('value');
if(!tokenSnapshot.exists()){
await chatRef.child('Token').set("device_bnnkklkcm34_1756732674868");
}
}catch(e){console.error('Structure setup failed:',e)}
}

async function verifyToken(){
const localTkn=localStorage.getItem('deviceToken');
if(!localTkn){block();return}
await ensureStructure();
try{
const snapshot=await db.ref('chatting/Token').once('value');
const allowedTkn=snapshot.val();
if(localTkn===allowedTkn){
verified=true;
renderChat();
}else{
block();
}
}catch(e){
block();
}
}

function renderChat(){
app.innerHTML=`<div class="chat">
<div class="header">Messages</div>
<div class="messages" id="msgs"></div>
<div class="input-area">
<textarea id="input" class="input" placeholder="Type a message..." rows="1"></textarea>
<button onclick="send()" class="send">â†’</button>
</div></div>`;
msgContainer=document.getElementById('msgs');
setupInput();
loadMsgs();
}

function setupInput(){
const inp=document.getElementById('input');
inp.addEventListener('keydown',e=>{
if(e.key==='Enter'&&!e.shiftKey){
e.preventDefault();
send();
}
});
inp.addEventListener('input',function(){
this.style.height='auto';
this.style.height=Math.min(this.scrollHeight,120)+'px';
});
}

function addMessage(msg,animate=true){
const d=document.createElement('div');
d.className=`msg ${msg.sender}`;
const t=new Date(msg.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
d.innerHTML=`<div class="bubble">${escapeHtml(msg.text)}<div class="time">${t}</div></div>`;
if(!animate)d.style.animation='none';
msgContainer.appendChild(d);
smoothScrollToBottom();
}

function smoothScrollToBottom(){
if(msgContainer){
msgContainer.scrollTo({
top:msgContainer.scrollHeight,
behavior:'smooth'
});
}
}

function escapeHtml(text){
const div=document.createElement('div');
div.textContent=text;
return div.innerHTML;
}

function renderMsgs(){
if(!msgContainer)return;
msgContainer.innerHTML='';
msgs.forEach((m,i)=>{
setTimeout(()=>addMessage(m,false),i*50);
});
}

function loadMsgs(){
if(!verified)return;
const bhrikutiRef=db.ref('chatting/messages/Bhrikuti');
const successRef=db.ref('chatting/messages/success');

function processMessages(){
const newMsgs=[];
Promise.all([
bhrikutiRef.once('value'),
successRef.once('value')
]).then(([bhrikutiSnap,successSnap])=>{
// Process Bhrikuti messages (left side)
if(bhrikutiSnap.exists()){
Object.entries(bhrikutiSnap.val()).forEach(([id,msg])=>{
if(msg&&msg.text)newMsgs.push({...msg,sender:'user',id:'bhrikuti_'+id});
});
}
// Process success messages (right side)
if(successSnap.exists()){
Object.entries(successSnap.val()).forEach(([id,msg])=>{
if(msg&&msg.text)newMsgs.push({...msg,sender:'me',id:'success_'+id});
});
}

newMsgs.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));

const oldCount=msgs.length;
const newCount=newMsgs.length;
msgs=newMsgs;

if(newCount>oldCount&&msgContainer){
const newMessages=msgs.slice(oldCount);
newMessages.forEach(msg=>addMessage(msg,true));
}else if(oldCount===0){
renderMsgs();
}
});
}

bhrikutiRef.on('value',processMessages);
successRef.on('value',processMessages);
}

async function send(){
if(!verified)return;
const i=document.getElementById('input');
const txt=i.value.trim();
if(!txt)return;

const localTkn=localStorage.getItem('deviceToken');
const isFriend=localTkn==="device_bnnkklkcm34_1756732674868";
const targetPath=isFriend?'chatting/messages/Bhrikuti':'chatting/messages/success';

i.value='';
i.style.height='auto';
i.focus();

try{
await db.ref(targetPath).push({
text:txt,
timestamp:new Date().toISOString(),
user:localTkn
});
}catch(e){
console.error('Send failed:',e);
}
}

document.addEventListener('DOMContentLoaded',verifyToken);
</script>
</body>
</html>