<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Imposter</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        .title {
            font-size: min(8vw, 2.5rem);
            margin-bottom: 2vh;
            color: #0ff;
        }

        .dots {
            display: flex;
            gap: 1vw;
            margin: 2vh 0;
        }

        .dot {
            width: min(3vw, 12px);
            height: min(3vw, 12px);
            background: #0ff;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.3s; }
        .dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .word {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #0ff;
            color: #fff;
            padding: min(8vw, 3rem);
            border-radius: min(4vw, 1rem);
            font-size: min(12vw, 3rem);
            font-weight: 800;
            margin: 3vh 0;
            box-shadow: 0 0 min(8vw, 2rem) rgba(0,255,255,0.3);
            transition: all 0.3s ease;
            max-width: 90vw;
            word-break: break-word;
        }

        .imposter {
            background: linear-gradient(135deg, #2d1b69, #8b1538);
            border-color: #f0f;
            box-shadow: 0 0 min(8vw, 2rem) rgba(255,0,255,0.3);
        }

        .word.hidden {
            opacity: 0;
            transform: scale(0.9);
        }

        .status {
            font-size: min(4vw, 1rem);
            color: #0ff;
            margin: 1vh 0;
            opacity: 0.8;
        }

        .players {
            font-size: min(3vw, 0.8rem);
            color: #888;
            position: absolute;
            bottom: 2vh;
            opacity: 0.6;
        }

        .config {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #0ff;
            padding: min(6vw, 1.5rem);
            border-radius: min(3vw, 0.8rem);
            box-shadow: 0 0 min(10vw, 3rem) rgba(0,255,255,0.4);
            display: none;
            z-index: 1000;
            width: min(90vw, 20rem);
            max-height: 90vh;
            overflow-y: auto;
        }

        .config h3 {
            font-size: min(5vw, 1.2rem);
            margin-bottom: min(4vw, 1rem);
            color: #0ff;
        }

        .config-item {
            margin-bottom: min(3vw, 0.8rem);
        }

        .config-label {
            display: block;
            font-size: min(3.5vw, 0.8rem);
            color: #0ff;
            margin-bottom: min(1vw, 0.3rem);
        }

        .config-input, .config-select {
            width: 100%;
            padding: min(2vw, 0.5rem);
            border: 1px solid #333;
            border-radius: min(1vw, 0.3rem);
            background: #111;
            color: #fff;
            font-size: min(3vw, 0.8rem);
        }

        .config-input:focus, .config-select:focus {
            outline: none;
            border-color: #0ff;
        }

        .config-row {
            display: flex;
            gap: min(2vw, 0.5rem);
        }

        .config-row .config-item {
            flex: 1;
            margin-bottom: 0;
        }

        .range-display {
            text-align: center;
            font-size: min(3vw, 0.7rem);
            color: #888;
            margin-top: min(1vw, 0.2rem);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: min(2vw, 0.5rem);
            margin: min(2vw, 0.5rem) 0;
        }

        .checkbox-item input {
            width: min(4vw, 1rem);
            height: min(4vw, 1rem);
        }

        .checkbox-item label {
            font-size: min(3vw, 0.7rem);
        }

        .save-btn {
            background: linear-gradient(45deg, #0ff, #f0f);
            color: #000;
            border: none;
            padding: min(3vw, 0.8rem);
            border-radius: min(2vw, 0.5rem);
            width: 100%;
            font-size: min(4vw, 1rem);
            font-weight: 600;
            cursor: pointer;
            margin-top: min(3vw, 1rem);
        }

        .loading::after {
            content: '';
            animation: dots 2s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @media (max-height: 500px) {
            .title { font-size: min(6vw, 1.5rem); margin-bottom: 1vh; }
            .word { padding: min(6vw, 2rem); font-size: min(10vw, 2rem); margin: 2vh 0; }
            .dots { margin: 1vh 0; }
        }
    </style>
</head>
<body>
    <div class="game" id="game">
        <h1 class="title">Word Imposter</h1>
        <div class="dots" id="animation">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <div class="status" id="status">Tap to start</div>
        <div class="players" id="players"></div>
    </div>

    <div class="config" id="config">
        <h3>Settings</h3>
        <div class="config-item">
            <label class="config-label">Imposters:</label>
            <input type="range" class="config-input" id="imposters" min="0" max="10" value="1">
            <div class="range-display" id="impostersDisplay">1</div>
        </div>
        <div class="config-row">
            <div class="config-item">
                <label class="config-label">Category:</label>
                <select class="config-select" id="category">
                    <option value="mixed">Mixed</option>
                    <option value="animals">Animals</option>
                    <option value="countries">Countries</option>
                    <option value="objects">Objects</option>
                    <option value="food">Food</option>
                </select>
            </div>
            <div class="config-item">
                <label class="config-label">Difficulty:</label>
                <select class="config-select" id="difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
        </div>
        <div class="config-row">
            <div class="config-item">
                <label class="config-label">Min Players:</label>
                <input type="number" class="config-input" id="minPlayers" min="2" max="20" value="2">
            </div>
            <div class="config-item">
                <label class="config-label">Max Players:</label>
                <input type="number" class="config-input" id="maxPlayers" min="2" max="50" value="10">
            </div>
        </div>
        <div class="config-item">
            <div class="checkbox-item">
                <input type="checkbox" id="properNouns">
                <label>Proper Nouns</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="plurals">
                <label>Plurals</label>
            </div>
        </div>
        <button class="save-btn" onclick="saveConfig()">Save</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, remove } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";
        
        const app = initializeApp({
            apiKey: "AIzaSyA6sANvYoAkXHYG8MjbZl6Pyq23CNdBuzA",
            authDomain: "community-canvas-255fa.firebaseapp.com",
            databaseURL: "https://community-canvas-255fa-default-rtdb.firebaseio.com",
            projectId: "community-canvas-255fa",
            storageBucket: "community-canvas-255fa.appspot.com",
            messagingSenderId: "729445267995",
            appId: "1:729445267995:web:05da6756d66c58b9ccd6be"
        });
        
        const db = getDatabase(app);
        const deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
        
        let processing = false;
        let longPress = null;
        let heartbeat = null;
        let cleanup = null;
        let visible = true;
        let gameData = null;
        let audioCtx;

        const game = document.getElementById('game');
        const status = document.getElementById('status');
        const players = document.getElementById('players');
        const config = document.getElementById('config');
        const animation = document.getElementById('animation');

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function ding() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.setValueAtTime(1200, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.6);
        }

        function startHeartbeat() {
            const send = () => set(ref(db, `players/${deviceId}`), { timestamp: Date.now() });
            send();
            const loop = () => {
                heartbeat = setTimeout(() => { send(); loop(); }, Math.random() * 4000 + 6000);
            };
            loop();
        }

        function startCleanup() {
            const clean = () => {
                get(ref(db, 'players')).then(snap => {
                    const p = snap.val() || {};
                    const now = Date.now();
                    for (const [id, data] of Object.entries(p)) {
                        if (now - data.timestamp > 60000) remove(ref(db, `players/${id}`));
                    }
                });
            };
            const loop = () => {
                cleanup = setTimeout(() => { clean(); loop(); }, Math.random() * 30000 + 45000);
            };
            loop();
        }

        async function getWord() {
            const cfg = await get(ref(db, 'gameConfig'));
            const c = cfg.val() || {};
            const cat = c.category || 'mixed';
            const diff = c.difficulty || 'easy';
            const proper = c.properNouns ? '' : ' No proper nouns.';
            const plural = c.plurals ? '' : ' No plurals.';
            
            let catPrompt = '';
            switch(cat) {
                case 'animals': catPrompt = 'animal'; break;
                case 'countries': catPrompt = 'country'; break;
                case 'objects': catPrompt = 'object'; break;
                case 'food': catPrompt = 'food'; break;
                default: catPrompt = 'word';
            }

            const prompt = `Generate one ${diff} ${catPrompt} for guessing game.${proper}${plural} Just the word.`;
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyAioo23YXTQAxFZ9J5OGlzd3WrjPYW9IEY`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { maxOutputTokens: 5, temperature: 0.9 }
                })
            });

            const data = await res.json();
            return data.candidates[0].content.parts[0].text.trim().toLowerCase();
        }

        async function getActivePlayers() {
            const snap = await get(ref(db, 'players'));
            const p = snap.val() || {};
            const now = Date.now();
            return Object.keys(p).filter(id => now - p[id].timestamp < 60000);
        }

        async function startGame() {
            if (processing) return;
            processing = true;

            try {
                status.innerHTML = 'Getting word<span class="loading"></span>';
                animation.style.display = 'none';

                const word = await getWord();
                const activePlayers = await getActivePlayers();
                const cfg = await get(ref(db, 'gameConfig'));
                const c = cfg.val() || {};
                
                const min = c.minPlayers || 2;
                const max = c.maxPlayers || 10;

                if (activePlayers.length < min) {
                    status.textContent = `Need ${min} players`;
                    animation.style.display = 'flex';
                    processing = false;
                    setTimeout(() => status.textContent = 'Tap to start', 3000);
                    return;
                }

                const playersToUse = activePlayers.slice(0, max);
                const shuffled = [...playersToUse].sort(() => Math.random() - 0.5);
                const numImposters = Math.min(parseInt(c.imposters || 1), playersToUse.length - 1);
                const imposters = shuffled.slice(0, numImposters);

                await set(ref(db, 'currentGame'), {
                    word,
                    players: playersToUse,
                    imposters,
                    timestamp: Date.now()
                });
                
            } catch (error) {
                status.textContent = 'Error';
                animation.style.display = 'flex';
                processing = false;
                setTimeout(() => status.textContent = 'Tap to start', 3000);
            }
        }

        function showResult(word, isImposter) {
            ding();
            gameData = { word, isImposter };

            game.innerHTML = `
                <div class="word ${isImposter ? 'imposter' : ''}" id="wordDisplay">
                    ${isImposter ? 
                        '<div><div style="font-size: 1.5em; margin-bottom: 0.2em;">🕵️</div><div>IMPOSTER</div><div style="font-size: 0.6em; margin-top: 0.2em; opacity: 0.8;">Blend in!</div></div>' :
                        `<div><div style="font-size: 0.6em; margin-bottom: 0.2em; opacity: 0.8;">Word:</div><div style="text-transform: uppercase;">${word}</div><div style="font-size: 0.6em; margin-top: 0.2em; opacity: 0.8;">Find imposter!</div></div>`
                    }
                </div>
                <div class="status" id="status">Tap for new game</div>
                <div class="players" id="players"></div>
            `;

            processing = false;
            visible = true;
            updatePlayers();
        }

        function toggleVisibility() {
            if (!gameData) return;
            const wordEl = document.getElementById('wordDisplay');
            if (wordEl) {
                visible = !visible;
                wordEl.classList.toggle('hidden', !visible);
            }
        }

        function updatePlayers() {
            onValue(ref(db, 'players'), snap => {
                const p = snap.val() || {};
                const now = Date.now();
                const count = Object.values(p).filter(data => now - data.timestamp < 60000).length;
                const playersEl = document.getElementById('players');
                if (playersEl) playersEl.textContent = `${count} active`;
                
                // Update imposter range
                const impostersInput = document.getElementById('imposters');
                if (impostersInput) {
                    const maxImposters = Math.max(0, count - 1);
                    impostersInput.max = maxImposters;
                    if (parseInt(impostersInput.value) > maxImposters) {
                        impostersInput.value = maxImposters;
                        updateRange();
                    }
                }
            });
        }

        function updateRange() {
            const impostersInput = document.getElementById('imposters');
            const display = document.getElementById('impostersDisplay');
            if (display) display.textContent = impostersInput.value;
        }

        async function loadConfig() {
            try {
                const cfg = await get(ref(db, 'gameConfig'));
                const c = cfg.val();
                if (c) {
                    document.getElementById('imposters').value = c.imposters || 1;
                    document.getElementById('category').value = c.category || 'mixed';
                    document.getElementById('difficulty').value = c.difficulty || 'easy';
                    document.getElementById('minPlayers').value = c.minPlayers || 2;
                    document.getElementById('maxPlayers').value = c.maxPlayers || 10;
                    document.getElementById('properNouns').checked = c.properNouns || false;
                    document.getElementById('plurals').checked = c.plurals || false;
                    updateRange();
                }
            } catch (e) {}
        }

        function showConfig() {
            config.style.display = 'block';
            loadConfig();
        }

        window.saveConfig = function() {
            const c = {
                imposters: document.getElementById('imposters').value,
                category: document.getElementById('category').value,
                difficulty: document.getElementById('difficulty').value,
                minPlayers: document.getElementById('minPlayers').value,
                maxPlayers: document.getElementById('maxPlayers').value,
                properNouns: document.getElementById('properNouns').checked,
                plurals: document.getElementById('plurals').checked
            };
            set(ref(db, 'gameConfig'), c);
            config.style.display = 'none';
        };

        // Event listeners
        document.getElementById('imposters').addEventListener('input', updateRange);
        
        onValue(ref(db, 'currentGame'), snap => {
            const data = snap.val();
            if (data && !processing && Date.now() - data.timestamp < 30000) {
                if (data.players.includes(deviceId)) {
                    showResult(data.word, data.imposters.includes(deviceId));
                }
            }
        });

        game.addEventListener('touchstart', e => {
            e.preventDefault();
            initAudio();
            longPress = setTimeout(() => showConfig(), 5000);
            if (gameData) toggleVisibility();
            else if (!processing) startGame();
        });

        game.addEventListener('touchend', e => {
            e.preventDefault();
            if (longPress) { clearTimeout(longPress); longPress = null; }
        });

        game.addEventListener('mousedown', e => {
            e.preventDefault();
            initAudio();
            longPress = setTimeout(() => showConfig(), 5000);
            if (gameData) toggleVisibility();
            else if (!processing) startGame();
        });

        game.addEventListener('mouseup', e => {
            e.preventDefault();
            if (longPress) { clearTimeout(longPress); longPress = null; }
        });

        // Initialize
        startHeartbeat();
        startCleanup();
        updatePlayers();
        loadConfig();
    </script>
</body>
</html>
