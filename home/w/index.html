<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Watch AI</title>
    <style>
        :root {
            --bg: #000;
            --text: #fff;
            --primary: #3b82f6;
            --accent: #ef4444;
            --muted: #666;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
        }
        #log_container {
            flex: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            scroll-behavior: smooth;
            padding-bottom: 40px;
        }
        .entry { font-size: 18px; line-height: 1.4; word-wrap: break-word; }
        .entry.ai { color: #fff; border-left: 3px solid var(--primary); padding-left: 8px; }
        .entry.user { color: var(--primary); text-align: right; font-style: italic; }
        .entry.system { color: var(--muted); font-size: 12px; text-align: center; }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        #overlay.active { display: flex; }
        .mic-icon {
            width: 80px; height: 80px; border-radius: 50%;
            background: var(--primary); display: flex;
            justify-content: center; align-items: center;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        #status {
            position: fixed; top: 5px; right: 5px; font-size: 10px; color: var(--muted);
        }

        #login_trigger {
            position: fixed; top: 0; left: 0; width: 40px; height: 40px; z-index: 200;
        }
    </style>
</head>
<body>
    <div id="login_trigger"></div>
    <div id="status">OFFLINE</div>
    <div id="log_container">
        <div class="entry system">HOLD SCREEN TO TALK</div>
    </div>
    <div id="overlay">
        <div class="mic-icon">
            <svg viewBox="0 0 24 24" width="40" height="40" fill="white">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script type="module">
        import firebaseConfig from '../assets/js/config.js';

        const container = document.getElementById('log_container');
        const overlay = document.getElementById('overlay');
        const statusEl = document.getElementById('status');
        const loginTrigger = document.getElementById('login_trigger');

        // Firebase Setup
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;
        let recognition = null;
        let isListening = false;
        let isInitialLoad = true;

        // Auth handling
        auth.onAuthStateChanged(user => {
            currentUser = user;
            statusEl.textContent = user ? "READY" : "LOCKED";
            statusEl.style.color = user ? "#4ade80" : "#ef4444";
            if (!user) {
                const savedPass = localStorage.getItem('watch_pass');
                if (savedPass) {
                    auth.signInWithEmailAndPassword("successadhikari1234@gmail.com", savedPass)
                        .catch(() => localStorage.removeItem('watch_pass'));
                }
            }
        });

        loginTrigger.addEventListener('dblclick', () => {
            const pass = prompt("Access Key:");
            if (pass) {
                auth.signInWithEmailAndPassword("successadhikari1234@gmail.com", pass)
                    .then(() => localStorage.setItem('watch_pass', pass))
                    .catch(err => alert("Fail: " + err.message));
            }
        });

        // Database Listeners
        const logsRef = db.ref('home_system/logs').limitToLast(10);
        logsRef.on('child_added', (s) => {
            const log = s.val();
            if (!log) return;
            appendLog(log, !isInitialLoad);
        });

        // Mark initial load finished after a short delay
        setTimeout(() => { isInitialLoad = false; }, 2000);

        function appendLog(log, shouldSpeak) {
            const div = document.createElement('div');
            let type = 'system';
            let content = log.message;

            if (log.type === 'ai_raw') {
                type = 'ai';
                content = content.replace(/(AI THOUGHT:|THOUGHT:)(.*?)(?=\n|$)/g, '').trim();
                if (!content) return;
                if (shouldSpeak) speak(content);
            } else if (log.type === 'user_msg') {
                type = 'user';
            } else if (log.type === 'info') {
                return;
            }

            div.className = `entry ${type}`;
            div.textContent = content;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            while (container.children.length > 20) {
                container.removeChild(container.firstChild);
            }
        }

        // Voice Logic
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                processVoiceInput(text);
            };

            recognition.onerror = (e) => {
                console.error("STT Error", e.error);
                overlay.classList.remove('active');
                if (window.navigator.vibrate) window.navigator.vibrate([50, 50]);
            };

            recognition.onend = () => {
                overlay.classList.remove('active');
                isListening = false;
            };
        }

        function speak(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.1; 
            window.speechSynthesis.speak(utterance);
        }

        async function processVoiceInput(text) {
            if (window.navigator.vibrate) window.navigator.vibrate(50);
            
            if (text.toLowerCase().includes("terminate")) {
                db.ref('home_system/server_info/stop_requested').set(true);
                const div = document.createElement('div');
                div.className = 'entry system';
                div.style.color = 'var(--accent)';
                div.textContent = "TERMINATING...";
                container.appendChild(div);
                return;
            }

            if (currentUser) {
                db.ref('home_system/commands').set({
                    type: 'ai',
                    prompt: text,
                    timestamp: Date.now() / 1000
                });
                
                const div = document.createElement('div');
                div.className = 'entry user';
                div.textContent = text;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            } else {
                alert("LOCKED. Dbl-tap top left.");
            }
        }

        // Interaction
        let holdTimer;
        function startHold(e) {
            if (isListening) return;
            holdTimer = setTimeout(() => {
                if (recognition) {
                    isListening = true;
                    overlay.classList.add('active');
                    recognition.start();
                    if (window.navigator.vibrate) window.navigator.vibrate(60);
                }
            }, 400);
        }

        function endHold() {
            clearTimeout(holdTimer);
            if (isListening && recognition) {
                recognition.stop();
            }
        }

        window.addEventListener('mousedown', startHold);
        window.addEventListener('mouseup', endHold);
        window.addEventListener('touchstart', (e) => { startHold(e); });
        window.addEventListener('touchend', endHold);
    </script>
</body>
</html>
